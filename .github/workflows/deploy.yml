name: Build and Deploy

on:
  push:
    branches: [ 'main', 'develop' ]  # å¿…è¦ãªãƒ–ãƒ©ãƒ³ãƒã®ã¿ã«åˆ¶é™
  pull_request:
    branches: [ '**' ]

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™ã‚’æœ€å°ã«
permissions:
  contents: read

jobs:
  build:
    name: Build Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 1
          
      - name: Notify Slack on Build Success
        if: success() && github.ref == 'refs/heads/main'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            âœ… *BDiff ãƒ“ãƒ«ãƒ‰æˆåŠŸ*
            
            ğŸ“ **è©³ç´°:**
            â€¢ **ãƒ–ãƒ©ãƒ³ãƒ:** `${{ github.ref_name }}`
            â€¢ **ã‚³ãƒŸãƒƒãƒˆ:** `${{ github.sha }}`
            â€¢ **ä½œæˆè€…:** ${{ github.actor }}
            
            ğŸ”— **ãƒªãƒ³ã‚¯:**
            â€¢ [Commit](${{ github.event.head_commit.url }})
            â€¢ [Action](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Notify Slack on Build Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          text: |
            âŒ *BDiff ãƒ“ãƒ«ãƒ‰å¤±æ•—*
            
            ğŸ“ **è©³ç´°:**
            â€¢ **ãƒ–ãƒ©ãƒ³ãƒ:** `${{ github.ref_name }}`
            â€¢ **ã‚³ãƒŸãƒƒãƒˆ:** `${{ github.sha }}`
            â€¢ **ä½œæˆè€…:** ${{ github.actor }}
            
            ğŸ”— **ãƒªãƒ³ã‚¯:**
            â€¢ [å¤±æ•—ã—ãŸAction](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ [Commit](${{ github.event.head_commit.url }})
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build
    
    permissions:
      contents: read
      deployments: write
      
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/
          
      - name: Deploy to Cloudflare Pages (Production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=bdiff
          
      - name: Notify Slack on Production Deploy Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            ğŸš€ *BDiff æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ* 
            
            ğŸ“ **è©³ç´°:**
            â€¢ **ç’°å¢ƒ:** Production (https://bdiff.v41.me)
            â€¢ **ãƒ–ãƒ©ãƒ³ãƒ:** `${{ github.ref_name }}`
            â€¢ **ã‚³ãƒŸãƒƒãƒˆ:** `${{ github.sha }}`
            â€¢ **ä½œæˆè€…:** ${{ github.actor }}
            
            ğŸ”— **ãƒªãƒ³ã‚¯:**
            â€¢ [Live Site](https://bdiff.v41.me)
            â€¢ [Commit](${{ github.event.head_commit.url }})
            â€¢ [Action](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Notify Slack on Production Deploy Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          text: |
            âŒ *BDiff æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—*
            
            ğŸ“ **è©³ç´°:**
            â€¢ **ç’°å¢ƒ:** Production
            â€¢ **ãƒ–ãƒ©ãƒ³ãƒ:** `${{ github.ref_name }}`
            â€¢ **ã‚³ãƒŸãƒƒãƒˆ:** `${{ github.sha }}`
            â€¢ **ä½œæˆè€…:** ${{ github.actor }}
            
            ğŸ”— **ãƒªãƒ³ã‚¯:**
            â€¢ [å¤±æ•—ã—ãŸAction](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ [Commit](${{ github.event.head_commit.url }})
            
            ğŸ› ï¸ **å¯¾å¿œãŒå¿…è¦ã§ã™**
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-preview:
    name: Deploy to Preview
    runs-on: ubuntu-latest
    # ãƒ•ã‚©ãƒ¼ã‚¯ã‹ã‚‰ã®PRã‚’é™¤å¤– + mainãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ã®PRã®ã¿
    if: >-
      github.event_name == 'pull_request'
      && github.base_ref != 'main'
      && github.event.pull_request.head.repo.full_name == github.repository
    
    permissions:
      contents: read
      deployments: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Deploy to Cloudflare Pages (Preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=bdiff
          
      - name: Notify Slack on Preview Deploy Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'  
          text: |
            ğŸ” *BDiff ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ*
            
            ğŸ“ **è©³ç´°:**
            â€¢ **ç’°å¢ƒ:** Preview
            â€¢ **PR:** #${{ github.event.number }} - ${{ github.event.pull_request.title }}
            â€¢ **ãƒ–ãƒ©ãƒ³ãƒ:** `${{ github.head_ref }}`
            â€¢ **ä½œæˆè€…:** ${{ github.actor }}
            
            ğŸ”— **ãƒªãƒ³ã‚¯:**
            â€¢ [PR](${{ github.event.pull_request.html_url }})
            â€¢ [Action](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Notify Slack on Preview Deploy Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          text: |
            âŒ *BDiff ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—*
            
            ğŸ“ **è©³ç´°:**
            â€¢ **ç’°å¢ƒ:** Preview
            â€¢ **PR:** #${{ github.event.number }} - ${{ github.event.pull_request.title }}
            â€¢ **ãƒ–ãƒ©ãƒ³ãƒ:** `${{ github.head_ref }}`
            â€¢ **ä½œæˆè€…:** ${{ github.actor }}
            
            ğŸ”— **ãƒªãƒ³ã‚¯:**
            â€¢ [å¤±æ•—ã—ãŸAction](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ [PR](${{ github.event.pull_request.html_url }})
            
            ğŸ› ï¸ **å¯¾å¿œãŒå¿…è¦ã§ã™**
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}