# ファイル差分確認システム 設計書

## 1. システム概要

### 1.1 プロジェクト名
**bdiff** (Beautiful Diff Viewer)

### 1.2 目的
ファイルの差分を視覚的に分かりやすく表示し、コードレビューやファイル比較を効率的に行うためのWebアプリケーション

### 1.3 主要機能
- ファイルアップロード/テキスト直接入力による比較
- 差分の視覚的表示（追加/削除/変更箇所のハイライト）
- 行番号表示と同期スクロール
- 差分統計情報の表示
- モバイル対応レスポンシブデザイン

### 1.4 技術スタック
- **フロントエンド**: React 18 + TypeScript
- **スタイリング**: Tailwind CSS
- **ビルドツール**: Vite
- **ホスティング**: Cloudflare Pages
- **パッケージマネージャー**: npm

### 1.5 デザインコンセプト
- Any.doのようなシンプルで洗練されたUI
- ミニマルなデザインで機能に集中
- 直感的な操作性
- アクセシビリティへの配慮

## 2. アーキテクチャ設計

### 2.1 ディレクトリ構成
```
bdiff/
├── claudedocs/           # 設計書・ドキュメント
├── public/              # 静的ファイル
│   └── deployment-info.json
├── src/
│   ├── components/      # Reactコンポーネント
│   │   ├── ui/         # 再利用可能なUIコンポーネント
│   │   │   ├── Button.tsx
│   │   │   ├── Card.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Modal.tsx
│   │   │   └── Badge.tsx
│   │   ├── diff/       # 差分表示関連コンポーネント
│   │   │   ├── DiffViewer.tsx
│   │   │   ├── DiffStats.tsx
│   │   │   ├── LineNumber.tsx
│   │   │   └── DiffLine.tsx
│   │   ├── input/      # 入力関連コンポーネント
│   │   │   ├── FileUpload.tsx
│   │   │   ├── TextInput.tsx
│   │   │   └── InputSelector.tsx
│   │   ├── layout/     # レイアウトコンポーネント
│   │   │   ├── Header.tsx
│   │   │   ├── PageLayout.tsx
│   │   │   └── MobileNav.tsx
│   │   └── common/     # 共通コンポーネント
│   │       ├── LoadingSpinner.tsx
│   │       ├── ErrorBoundary.tsx
│   │       ├── Toast.tsx
│   │       └── EmptyState.tsx
│   ├── hooks/          # カスタムフック
│   │   ├── useDiff.ts
│   │   ├── useFileReader.ts
│   │   └── useToast.ts
│   ├── pages/          # ページコンポーネント
│   │   ├── HomePage.tsx
│   │   └── DiffPage.tsx
│   ├── services/       # ビジネスロジック
│   │   ├── diffService.ts
│   │   └── fileService.ts
│   ├── stores/         # 状態管理
│   │   └── diffStore.ts
│   ├── styles/         # スタイル
│   │   └── global.css
│   ├── types/          # TypeScript型定義
│   │   └── types.ts
│   ├── utils/          # ユーティリティ関数
│   │   ├── diffAlgorithm.ts
│   │   └── formatters.ts
│   ├── App.tsx
│   ├── main.tsx
│   └── vite-env.d.ts
├── .gitignore
├── index.html
├── package.json
├── postcss.config.js
├── tailwind.config.js
├── tsconfig.json
├── tsconfig.node.json
├── vite.config.ts
└── wrangler.toml       # Cloudflare Pages設定
```

### 2.2 コンポーネント階層
```
App
├── PageLayout
│   ├── Header
│   │   └── MobileNav
│   └── [Page Content]
├── HomePage
│   ├── InputSelector
│   │   ├── FileUpload
│   │   └── TextInput
│   └── Button (Compare)
└── DiffPage
    ├── DiffStats
    └── DiffViewer
        ├── LineNumber
        └── DiffLine
```

## 3. 機能詳細設計

### 3.1 入力機能

#### 3.1.1 ファイルアップロード
- ドラッグ&ドロップ対応
- ファイル選択ダイアログ
- 複数ファイル対応（2ファイルまで）
- サポートファイル形式：テキストファイル全般
- ファイルサイズ制限：10MB

#### 3.1.2 テキスト直接入力
- テキストエリアによる直接入力
- ペースト対応
- クリアボタン
- 文字数カウンター

### 3.2 差分表示機能

#### 3.2.1 差分アルゴリズム
- Myers差分アルゴリズムを使用
- 行単位での差分検出
- 効率的な最長共通部分列（LCS）の計算

#### 3.2.2 表示モード
- **Side-by-side表示**: 左右に並べて表示
- **Unified表示**: 統合ビューで表示
- **Split表示**: 変更箇所のみハイライト

#### 3.2.3 視覚的表現
- 追加行：緑色背景（#d4f4dd）
- 削除行：赤色背景（#fdd4d4）
- 変更行：黄色背景（#fef3c7）
- 行番号表示
- 同期スクロール

### 3.3 統計情報表示
- 追加行数
- 削除行数
- 変更行数
- 類似度パーセンテージ

### 3.4 レスポンシブデザイン
- モバイル（< 640px）
- タブレット（640px - 1024px）
- デスクトップ（> 1024px）

## 4. データモデル

### 4.1 型定義

```typescript
// 差分タイプ
export type DiffType = 'added' | 'removed' | 'unchanged' | 'modified';

// 差分行
export interface DiffLine {
  lineNumber: number;
  content: string;
  type: DiffType;
  originalLineNumber?: number;
  newLineNumber?: number;
}

// ファイル情報
export interface FileInfo {
  name: string;
  content: string;
  size: number;
  lastModified?: Date;
}

// 差分結果
export interface DiffResult {
  lines: DiffLine[];
  stats: DiffStats;
}

// 差分統計
export interface DiffStats {
  added: number;
  removed: number;
  modified: number;
  unchanged: number;
  similarity: number; // パーセンテージ
}

// 表示モード
export type ViewMode = 'side-by-side' | 'unified' | 'split';

// 入力タイプ
export type InputType = 'file' | 'text';
```

## 5. 状態管理

### 5.1 グローバル状態
```typescript
interface DiffStore {
  // 入力データ
  originalFile: FileInfo | null;
  modifiedFile: FileInfo | null;
  inputType: InputType;
  
  // 差分結果
  diffResult: DiffResult | null;
  isProcessing: boolean;
  error: string | null;
  
  // 表示設定
  viewMode: ViewMode;
  showLineNumbers: boolean;
  syntaxHighlight: boolean;
  
  // アクション
  setOriginalFile: (file: FileInfo) => void;
  setModifiedFile: (file: FileInfo) => void;
  calculateDiff: () => Promise<void>;
  clearAll: () => void;
  setViewMode: (mode: ViewMode) => void;
}
```

## 6. UIデザイン仕様

### 6.1 カラーパレット
```css
/* プライマリカラー */
--primary: #2563eb;        /* ブルー */
--primary-hover: #1d4ed8;

/* セカンダリカラー */
--secondary: #64748b;      /* グレー */
--secondary-hover: #475569;

/* 背景色 */
--bg-primary: #ffffff;
--bg-secondary: #f8fafc;
--bg-tertiary: #f1f5f9;

/* テキストカラー */
--text-primary: #0f172a;
--text-secondary: #475569;
--text-tertiary: #94a3b8;

/* 差分表示カラー */
--diff-added: #d4f4dd;
--diff-added-dark: #16a34a;
--diff-removed: #fdd4d4;
--diff-removed-dark: #dc2626;
--diff-modified: #fef3c7;
--diff-modified-dark: #ca8a04;

/* ボーダー */
--border: #e2e8f0;
--border-focus: #2563eb;
```

### 6.2 タイポグラフィ
```css
/* フォントファミリー */
--font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
--font-mono: 'JetBrains Mono', 'Monaco', 'Courier New', monospace;

/* フォントサイズ */
--text-xs: 0.75rem;    /* 12px */
--text-sm: 0.875rem;   /* 14px */
--text-base: 1rem;     /* 16px */
--text-lg: 1.125rem;   /* 18px */
--text-xl: 1.25rem;    /* 20px */
--text-2xl: 1.5rem;    /* 24px */
```

### 6.3 スペーシング
```css
/* パディング・マージン */
--space-1: 0.25rem;    /* 4px */
--space-2: 0.5rem;     /* 8px */
--space-3: 0.75rem;    /* 12px */
--space-4: 1rem;       /* 16px */
--space-5: 1.25rem;    /* 20px */
--space-6: 1.5rem;     /* 24px */
--space-8: 2rem;       /* 32px */
--space-10: 2.5rem;    /* 40px */
```

### 6.4 コンポーネントスタイル

#### ボタン
- プライマリ：青背景、白テキスト
- セカンダリ：グレー背景、ダークテキスト
- ゴースト：透明背景、青テキスト
- ホバー時：明度調整
- フォーカス時：アウトライン表示
- 無効時：opacity 0.5

#### 入力フィールド
- ボーダー：1px solid #e2e8f0
- フォーカス時：青ボーダー
- エラー時：赤ボーダー
- 角丸：0.375rem (6px)

#### カード
- 背景：白
- ボーダー：1px solid #e2e8f0
- シャドウ：0 1px 3px rgba(0,0,0,0.1)
- 角丸：0.5rem (8px)

## 7. 画面設計

### 7.1 ホーム画面
```
┌─────────────────────────────────────────┐
│ Header                                   │
├─────────────────────────────────────────┤
│                                         │
│     ファイル差分確認ツール               │
│     シンプルで高速な差分表示            │
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │ ファイル     │  │ テキスト     │     │
│  └─────────────┘  └─────────────┘     │
│                                         │
│  ┌───────────────────────────────┐     │
│  │ Original File                 │     │
│  │ Drop or Select              │     │
│  └───────────────────────────────┘     │
│                                         │
│  ┌───────────────────────────────┐     │
│  │ Modified File                 │     │
│  │ Drop or Select              │     │
│  └───────────────────────────────┘     │
│                                         │
│        [ 比較する ]                      │
│                                         │
└─────────────────────────────────────────┘
```

### 7.2 差分表示画面
```
┌─────────────────────────────────────────┐
│ Header                                   │
├─────────────────────────────────────────┤
│ Stats: +10 -5 ~3 | 85% similar          │
├─────────────────────────────────────────┤
│ View: [Side] [Unified] [Split]          │
├─────────────────────────────────────────┤
│  Original          │  Modified           │
│  ─────────────────┼─────────────────   │
│ 1│ function test() │ 1│ function test() │
│ 2│   return true   │ 2│   return false  │
│ 3│ }               │ 3│ }               │
│  │                 │ 4│ // Added line   │
└─────────────────────────────────────────┘
```

## 8. API/サービス設計

### 8.1 DiffService
```typescript
class DiffService {
  // Myers差分アルゴリズムによる差分計算
  calculateDiff(original: string, modified: string): DiffResult;
  
  // 差分結果のフォーマット
  formatDiffResult(result: DiffResult, mode: ViewMode): FormattedDiff;
  
  // 統計情報の計算
  calculateStats(lines: DiffLine[]): DiffStats;
  
  // 類似度の計算
  calculateSimilarity(original: string, modified: string): number;
}
```

### 8.2 FileService
```typescript
class FileService {
  // ファイル読み込み
  readFile(file: File): Promise<FileInfo>;
  
  // ファイルバリデーション
  validateFile(file: File): ValidationResult;
  
  // テキストエンコーディング検出
  detectEncoding(buffer: ArrayBuffer): string;
  
  // ファイルタイプ判定
  getFileType(filename: string): string;
}
```

## 9. パフォーマンス最適化

### 9.1 レンダリング最適化
- React.memoによるコンポーネントメモ化
- useMemoによる計算結果のキャッシュ
- 仮想スクロール（大規模ファイル対応）
- 遅延ローディング

### 9.2 差分計算最適化
- Web Workerでのバックグラウンド処理
- チャンク分割処理
- プログレッシブレンダリング

### 9.3 バンドルサイズ最適化
- コード分割（Code Splitting）
- Tree Shaking
- 動的インポート
- 画像最適化

## 10. セキュリティ考慮事項

### 10.1 入力検証
- ファイルサイズ制限（10MB）
- ファイルタイプ検証
- XSS対策（サニタイズ処理）

### 10.2 プライバシー
- ローカル処理（サーバー送信なし）
- ファイル内容の暗号化なし（ローカル完結）
- セッション終了時のメモリクリア

## 11. テスト戦略

### 11.1 単体テスト
- 差分アルゴリズムのテスト
- コンポーネントテスト（React Testing Library）
- カスタムフックのテスト

### 11.2 統合テスト
- ファイルアップロードフロー
- 差分表示フロー
- エラーハンドリング

### 11.3 E2Eテスト
- Playwright による自動テスト
- クロスブラウザテスト
- レスポンシブテスト

## 12. デプロイメント

### 12.1 ビルド設定
```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "deploy": "npm run build && wrangler pages deploy dist"
  }
}
```

### 12.2 Cloudflare Pages設定
```toml
# wrangler.toml
name = "bdiff"
compatibility_date = "2024-01-01"

[site]
bucket = "./dist"

[[routes]]
pattern = "/*"
zone_name = "example.com"
```

### 12.3 環境変数
```env
# .env.production
VITE_APP_VERSION=1.0.0
VITE_APP_ENV=production
```

## 13. 今後の拡張計画

### Phase 1 (MVP)
- [x] 基本的な差分表示
- [x] ファイルアップロード
- [x] テキスト入力
- [x] 統計情報表示

### Phase 2
- [ ] シンタックスハイライト
- [ ] 差分のエクスポート（PDF/HTML）
- [ ] URL共有機能
- [ ] キーボードショートカット

### Phase 3
- [ ] Git統合
- [ ] 複数ファイル比較
- [ ] ディレクトリ比較
- [ ] マージ機能

## 14. 参考資料

### デザインインスピレーション
- Any.do - タスク管理アプリ
- GitHub - 差分表示UI
- VS Code - エディタUI

### 技術リファレンス
- Myers差分アルゴリズム
- React公式ドキュメント
- Tailwind CSS
- Cloudflare Pages

---

作成日：2024年1月
作成者：Claude
バージョン：1.0.0